# Notion-Discord 同期システム仕様書

## 1. 概要

本ドキュメントは、DiscordとNotionを連携させるBotシステムの、最終的なデータベース設計、認証方式、および各種仕様を定義する。

当初のAIによる関連性判断方式から、ユーザーからの提案に基づき、より確実性・パフォーマンス・管理性に優れた、IDベースの堅牢な設計に変更した。

### 設計目標
- **確実性**: AIの曖昧さを排除し、DiscordのスレッドとNotionページを1対1で確実に紐付ける。
- **重複防止**: プログラムの多重実行や再実行時に、メッセージやファイルが重複して記録されないようにする（冪等性の確保）。
- **パフォーマンス**: Notionのページ数が増加しても、パフォーマンスが低下しないスケーラブルな設計とする。
- **ポータビリティ**: 実行環境（PC）に依存せず、どこからでも同じ状態で動作できるようにする。
- **管理性**: Notion上で人間が内容を把握しやすいように、ページのタイトルを最適化する。

---

## 2. データベース設計

システムは、以下の3つのNotionデータベースで構成される。

### ① Formテーブル (スレッド管理用)

Discordの各スレッドをNotionの1ページとして管理するためのメインテーブル。

| プロパティ名 | 種類 | 説明 |
|:---|:---|:---|
| **名前** (Title) | タイトル | Discordフォーラムの**スレッド名**を格納する。|
| **スレッドID** | テキスト | Discordの**スレッドID**を格納する。ページのユニークキーとして検索に利用。|
| **関連アセット** | リレーション | `Assetsテーブル`へのリレーション。このスレッドに投稿されたファイルを紐付ける。|
| 投稿日時 | 日付 | スレッドの初回投稿日時。|
| 投稿者 | テキスト | スレッドの初回投稿者名。|

### ② Assetsテーブル (ファイル管理用)

Discordに投稿された添付ファイルを管理するためのテーブル。

| プロパティ名 | 種類 | 説明 |
|:---|:---|:---|
| **ファイル名** (Title) | タイトル | 添付ファイルの元の名前。|
| **ファイルURL** | URL | Google Driveにアップロードされたファイルの永続的なURL。|
| **ファイル種別** | セレクト | `image/png`のようなファイル種別。|
| ファイルサイズ | 数値 | ファイルサイズ（バイト）。|
| 投稿日時 | 日付 | 元メッセージの投稿日時。|
| 関連メッセージ | リレーション | `Formテーブル`との逆参照（自動生成）。|

### ③ DoneMessagesテーブル (処理済みメッセージ管理用)

メッセージの重複処理を完全に防ぐための台帳テーブル。役割を明確にするため`Messagesテーブル`から改名。

| プロパティ名 | 種類 | 説明 |
|:---|:---|:---|
| **メッセージID** (Title) | タイトル | 処理が完了したDiscordの**メッセージID**を記録する。|
| **関連スレッド** | リレーション | `Formテーブル`へのリレーション。どのスレッドの処理だったかを記録する。|

---

## 3. 認証方式

### Google Drive API

ファイルの永続化に利用するGoogle Drive APIの認証は、**OAuth 2.0 クライアントID（デスクトップアプリ）**方式を採用する。

- **認証情報**: Google Cloud Platformで発行した`client_secrets.json`ファイルを利用する。
- **認証フロー**: 初回実行時のみ、ブラウザが起動しユーザーによる認証と権限の許可が求められる。認証後、アクセス情報が`token.json`ファイルに保存され、次回以降は自動で認証が行われる。
- **メリット**: サービスアカウントのストレージ容量問題を回避し、ユーザー自身のDriveアカウントに直接ファイルを保存できる。

---

## 4. 同期処理フロー (Discord → Notion)

1.  **処理済みIDの取得**: `DoneMessagesテーブル`に記録されている全ての`メッセージID`を取得し、処理済みIDのセットを作成する。
2.  **新規メッセージの取得**: Discordの対象チャンネルからメッセージを取得し、上記1のセットに含まれていない「未処理メッセージ」のみを処理対象とする。
3.  **ページ検索と処理の分岐**: 未処理メッセージごとに、それが属する**スレッドID**を取得する。
4.  **ページ検索**: `Formテーブル`を`スレッドID`で検索し、対応するページが存在するか確認する。
5.  **[ページが存在しない場合] → 新規作成処理**
    - `Formテーブル`に新しいページを作成する（タイトルはスレッド名、`スレッドID`プロパティも設定）。最初のメッセージはページ内のブロックとして書き込む。
6.  **[ページが存在する場合] → 追記処理**
    - 見つかった`Form`ページに、メッセージの本文を新しいブロックとして追記する。
7.  **添付ファイルの処理**: メッセージに添付ファイルがある場合、Google Driveにアップロードし、`Assetsテーブル`にその情報を記録。その後、対応する`Form`ページとリレーションを設定する。
8.  **処理済みとして記録**: 同期処理が完了したメッセージのIDを、`DoneMessagesテーブル`に新しく追加する。その際、どの`Form`ページに関連する処理だったかを`関連スレッド`リレーションで紐付ける。

---

## 5. Botの応答仕様

`/sync`コマンド実行後の応答は、処理結果に応じて以下の3パターンで返信する。

1.  **同期成功時**: 成功した旨と、実行した処理の概要（新規作成、追記など）を最大3件まで表示する。
    ```
    同期成功です。
    - スレッド「〇〇」を新規作成し、メッセージを追加しました。
    - スレッド「△△」にA子のメッセージを追加しました。（添付ファイル1件を含む）
    ...他5件の処理を行いました。
    ```

2.  **同期対象がなかった時**: 全てのメッセージが既に同期済みであることを伝える。
    ```
    全て同期済みです。
    ```

3.  **同期エラー時**: エラーが発生した旨と、具体的なエラーメッセージを伝える。
    ```
    同期エラーが発生しました:
    (具体的なエラー内容)
    ```