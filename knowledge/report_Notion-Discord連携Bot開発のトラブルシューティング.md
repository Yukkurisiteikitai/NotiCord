# Notion-Discord連携Bot開発における実践的トラブルシューティングレポート

## 1. はじめに

このレポートは、NotionとDiscordを双方向に連携するBotを開発する過程で直面した問題と、その解決を通じて得られた知見をまとめたものである。単なる機能実装だけでなく、API連携における実践的なデバッグ手法の記録として、同様のプロジェクト開発の助けとなることを目的とする。

## 2. 主な知見とトラブルシューティングの過程

開発は、大きく分けて「Discord Botの設計」「Notion API連携」の2つのフェーズで構成され、特に後者で段階的なデバッグが必要となった。

### 知見①：Discord Botの設計とコマンドデプロイ戦略

当初、`discord.Client`ベースで実装していたが、コマンド管理の明瞭化のため`discord.ext.commands.Bot`へリファクタリングを行った。この過程で、スラッシュコマンドのデプロイ（同期）に関する重要な知見が得られた。

- **問題**: スラッシュコマンドがDiscordのUIに表示されない、または反映が遅い。
- **原因**: グローバルコマンドの同期には最大1時間程度の時間がかかるため、開発中のテストには不向きである。
- **解決策**: 開発中は、特定のサーバー（ギルド）にのみコマンドを即時登録する「ギルドコマンド」を利用する。`.env`ファイルに`GUILD_ID`を設定し、Bot起動時にそのサーバーにのみコマンドを同期させることで、即時反映を実現した。これにより、開発サイクルを大幅に高速化できた。

### 知見②：多様なチャンネル形式への対応（テキスト vs フォーラム）

メッセージ履歴の読み取り処理において、特定のチャンネル形式でエラーが発生した。

- **問題**: `'ForumChannel' object has no attribute 'history'` というエラーが発生。
- **原因**: 同期対象に指定されたチャンネルが、通常の「テキストチャンネル」ではなく「フォーラムチャンネル」だった。フォーラムチャンネル自体はメッセージ履歴を持たず、内部の各スレッドがそれぞれ履歴を持つという構造の違いがあった。
- **解決策**: チャンネルの種類を`isinstance()`で判定するロジックを追加。フォーラムチャンネルの場合は、その内部にあるアクティブ及びアーカイブ済みのスレッドを走査し、各スレッドからメッセージ履歴を収集する処理に修正した。これにより、多様なチャンネル形式に柔軟に対応できるようになった。

### 知見③：Notion API連携における段階的デバッグ

Notion APIとの連携では、権限設定からデータベースの構造まで、複数のレイヤーで問題が発生した。これらは一度に解決するのではなく、エラーメッセージをヒントに段階的に解決する必要があった。

#### 第1段階：接続権限の確立

- **問題**: `Could not find database with ID...` または、そもそもインテグレーションが「コネクトの追加」に表示されない。
- **原因の探求**: 
  1.  データベースIDの不一致や、インテグレーションの共有忘れを疑った。
  2.  次に、Notionのプランや権限設定、リンクドデータベースの可能性を探った。
  3.  最終的に、ユーザーが発見した**APIのアップグレードガイド** (`2025-09-03`) が根本原因である可能性にたどり着いた。APIの仕様変更により、古い形式のインテグレーションがUIに表示されなくなっていたと推測される。
- **解決策**: **インテグレーションを新規に再作成する。** これにより、最新のAPIバージョンに準拠したインテグレーションが作成され、接続の問題がすべて解決した。APIのバージョンアップ直後は、既存の資産が動かなくなる可能性を念頭に置き、作り直しが有効な手段であることを学んだ。

#### 第2段階：データベーススキーマ（構造）の整合性

- **問題**: `名前 is not a property that exists.` というエラーが発生。
- **原因**: Botが書き込もうとしているプロパティ名（`名前`）と、実際にNotionデータベースに存在するプロパティ名が一致していなかった。
- **解決策**: エラーメッセージが示す通り、Notionデータベースのプロパティ名をコードの想定と完全に一致するように修正した。特に、Notionの「タイトル」プロパティはユーザーが自由に改名できるが、API経由でアクセスする場合はその名前がキーになることを再確認した。

## 3. 結論

API連携を伴うアプリケーション開発では、以下の点が重要であることを再認識した。

1.  **エラーメッセージを正確に読む**: APIが返すエラーは、問題解決の最も重要なヒントである。
2.  **段階的な切り分け**: 問題を一度に解決しようとせず、「接続」「権限」「データ構造」のようにレイヤーを分けて考える。
3.  **公式ドキュメントと仕様変更に注意する**: 特にAPIのバージョンアップ情報は、予期せぬ挙動の根本原因となりうるため、常に注意を払う必要がある。
4.  **「作り直す」勇気**: 設定が複雑化した際、一度クリーンな状態から再設定することで、見えない問題を解決できる場合がある。

本プロジェクトは、これらの実践的なデバッグプロセスを経て、安定した動作を実現するに至った。
